# Strategy
#
# 2 modes: simulate and publish
# - simulate: pachages versions numbers bump and npmj.com publication are simulated in the workflow
# - publication: a release branch is created that contains packages versions bumps and updated changelogs
#
# As we are using Rush version policies feature, we need to bump versions first:
# https://rushjs.io/pages/maintainer/publishing/#publishing-process-when-version-policies-are-used

name: ðŸš€ Publish packages

on:
  workflow_dispatch:
    inputs:
      MODE:
        description: Publication mode
        type: choice
        options:
          # Simulate the publication
          - simulate
          # Do the publication
          - publish
        default: simulate
        required: true
      VERSION_POLICY:
        description: Indicates how to increment packages version number
        type: choice
        options:
          # Increments according to their own minor or patch increment (depends of the type of changes made to each package)
          - individualVersion
          # Increments to the same major version. Use only for major releases.
          - lockStepVersion
        default: "individualVersion"
        required: true
  # debug
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      # MODE: ${{ inputs.MODE }}
      MODE: "publish"
      SOURCE_BRANCH: master # Force the master branch to be deployed: avoid the publication of WIP code from other branches
      TARGET_BRANCH: release/${{ github.run_id }}
      # VERSION_POLICY: ${{ inputs.VERSION_POLICY }}
      VERSION_POLICY: "individualVersion"
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
          ref: ${{ env.SOURCE_BRANCH }}

      - uses: actions/setup-node@v3
        with:
          node-version-file: .nvmrc

      - name: Git config user
        uses: snow-actions/git-config-user@v1.0.0
        with:
          name: Heart
          email: heart@fabernovel.com

      # simulate mode

      - name: Simulate packages versions numbers bump
        if: ${{ env.MODE == 'simulate' }}
        run: node common/scripts/install-run-rush.js version --bump --version-policy $VERSION_POLICY

      - name: Simulate a publication to npmjs.org with the version policy ${{ env.VERSION_POLICY }}
        if: ${{ env.MODE == 'simulate' }}
        run: node common/scripts/install-run-rush.js publish --include-all --target-branch $TARGET_BRANCH --version-policy $VERSION_POLICY

      # publish mode

      - name: Create origin/${{ env.TARGET_BRANCH }} branch
        if: ${{ env.MODE == 'publish' }}
        run: |
          git checkout -b $TARGET_BRANCH
          git push origin $TARGET_BRANCH
          git checkout $SOURCE_BRANCH

      - name: Bump packages versions numbers
        if: ${{ env.MODE == 'publish' }}
        run: node common/scripts/install-run-rush.js version --bump --target-branch $TARGET_BRANCH --version-policy $VERSION_POLICY

      # - name: Publish to npmjs.org with the version policy ${{ env.VERSION_POLICY }}
      #   if: ${{ env.MODE == 'publish' }}
      #   run: node common/scripts/install-run-rush.js publish --include-all --target-branch $TARGET_BRANCH --version-policy $VERSION_POLICY --publish

      - name: Create, approve and merge a Pull Request
        if:
          ${{ env.MODE == 'publish' }}
          # Use --merge to keep the Git tags added by the previous step and move them to the $TARGET_BRANCH
          # gh pr merge $TARGET_BRANCH --admin --merge --delete-branch
        run: |
          gh pr create --base $SOURCE_BRANCH --head $TARGET_BRANCH --title "Release $GITHUB_RUN_ID" --body "Packages have been published"
          gh pr review $TARGET_BRANCH --approve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
