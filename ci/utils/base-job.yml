.build:
  stage: build
  script:
    - node common/scripts/install-run-rush.js build --verbose
  artifacts:
    paths:
      - modules/
      - website/dist/
      - rush.json
    expire_in: 1 hour

.test:
  stage: test
  extends:
    - .install
    - .install-chrome
  before_script:
    - !reference [.install-chrome, before_script]
    - !reference [.install, before_script]

.coverage:
  extends:
    - .test
    - .only-master
  dependencies:
    - 🏗 Build for master
  coverage: /Branches\s+:\s\d+.?\d+/

.install:
  cache:
    key:
      files:
        - common/config/rush/pnpm-lock.yaml
    paths:
      - common/temp/node_modules/.pnpm
  before_script:
    # Update the rush.json repository url with the one used by the CI, to make the rush commands works
    - sed -i -e "s/$HOST_REPO_URL/$HOST_REPO_PIPELINE_URL/g" rush.json
    - node common/scripts/install-run-rush.js install

# required to use Puppeteer
.install-chrome:
  before_script:
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    - sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
    - apt-get update
    - apt-get install --yes google-chrome-stable
